<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Dettagli Meteo - Avanzato</title>
  <style>
    /* Reset e font base */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: sans-serif;
    }
    body {
      background-color: #f9f9f9;
      padding: 1rem;
    }

    /* Titolo e sottotitolo */
    .page-title {
      text-align: center;
      margin-bottom: 1rem;
    }
    .page-title h1 {
      font-size: 1.6rem;
      color: #444;
      margin-bottom: 0.3rem;
    }
    .page-title p {
      color: #666;
      font-size: 0.9rem;
    }

    /* Contenitore principale */
    .main-container {
      max-width: 1100px;
      margin: 0 auto;
    }

    /* Righe e card */
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    .card {
      flex: 1;
      min-width: 280px; /* larghezza minima di ogni card */
      background-color: #fff;
      border-radius: 6px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      padding: 1rem;
    }
    .card h3 {
      font-size: 1rem;
      margin-bottom: 0.5rem;
      color: #06776D;
      text-transform: uppercase;
    }
    .card p {
      font-size: 0.9rem;
      color: #444;
      margin-bottom: 0.3rem;
      line-height: 1.2rem;
    }
    /* Footer (opzionale) */
    footer {
      text-align: center;
      padding: 0.5rem;
      font-size: 0.9rem;
      color: #777;
      background-color: #f2f2f2;
      margin-top: 1rem;
    }
  </style>
</head>
<body>
  <!-- TITOLO E SOTTOTITOLO -->
  <div class="page-title">
    <h1 id="station-name">Stazione Meteo</h1>
    <p id="last-update">Ultimo aggiornamento: --/--/---- --:--:--</p>
  </div>

  <div class="main-container">
    <!-- RIGA 1: TEMPERATURA & UMIDITÀ -->
    <div class="row">
      <!-- CARD TEMPERATURA -->
      <div class="card">
        <h3>Temperatura</h3>
        <p>Attuale: <span id="temp-now">N/D</span> °C</p>
        <p>Min: <span id="temp-min">N/D</span> °C</p>
        <p>Max: <span id="temp-max">N/D</span> °C</p>
      </div>

      <!-- CARD UMIDITÀ -->
      <div class="card">
        <h3>Umidità</h3>
        <p>Attuale: <span id="humidity-now">N/D</span> %</p>
        <p>Min: <span id="humidity-min">N/D</span> %</p>
        <p>Max: <span id="humidity-max">N/D</span> %</p>
      </div>
    </div>

    <!-- RIGA 2: PIOGGIA -->
    <div class="row">
      <!-- CARD PIOGGIA ODIERNA -->
      <div class="card">
        <h3>Pioggia odierna</h3>
        <p><span id="rain-daily">N/D</span> mm</p>
      </div>

      <!-- CARD LIVELLI PIOGGIA -->
      <div class="card">
        <h3>Livelli Pioggia</h3>
        <p>Evento: <span id="rain-event">N/D</span> mm</p>
        <p>1H: <span id="rain-hourly">N/D</span> mm</p>
        <p>Settimana: <span id="rain-weekly">N/D</span> mm</p>
        <p>Mese: <span id="rain-monthly">N/D</span> mm</p>
        <p>Anno: <span id="rain-yearly">N/D</span> mm</p>
      </div>
    </div>

    <!-- RIGA 3: VENTO & PRESSIONE -->
    <div class="row">
      <!-- CARD VENTO -->
      <div class="card">
        <h3>Vento</h3>
        <p>Velocità: <span id="wind-speed">N/D</span> km/h</p>
        <p>Raffica: <span id="wind-gust">N/D</span> km/h</p>
        <p>Direzione: <span id="wind-direction">N/D</span> °</p>
      </div>

      <!-- CARD PRESSIONE -->
      <div class="card">
        <h3>Pressione</h3>
        <p><span id="pressure-now">N/D</span> hPa</p>
      </div>
    </div>

    <!-- RIGA 4: RADIAZIONE SOLARE & VARIE -->
    <div class="row">
      <div class="card">
        <h3>Radiazione solare</h3>
        <p>Solar: <span id="solar-now">N/D</span> W/m²</p>
        <p>UVI: <span id="uvi-now">N/D</span></p>
      </div>
    </div>
  </div>

  <footer>
    MeteoMarsia © 2025 - Tutti i diritti riservati
  </footer>

  <script>
    // Leggiamo il MAC dalla query string (es: dettagli2.html?mac=80:64:6F:3E:F7:C3)
    const params = new URLSearchParams(window.location.search);
    const MAC = params.get('mac') || '7C:87:CE:BE:93:0F';

    // Scegli un nome da mostrare in base al MAC (opzionale)
    // Puoi anche farlo dinamico se hai più stazioni.
    let stationName = 'Stazione Meteo';
    if (MAC === '7C:87:CE:BE:93:0F') {
      stationName = 'Tagliacozzo centro';
    } else if (MAC === '80:64:6F:3E:F7:C3') {
      stationName = 'Marsia (AQ)';
    }
    document.getElementById('station-name').textContent = stationName;

    // Chiavi Ecowitt
    const APPLICATION_KEY = '2BE0A47E434D61D1E866A12B03C9574D';
    const API_KEY = '92e76b42-2b76-41c2-9b33-f81c50aaddca';

    // Inizializza la pagina
    async function initPage() {
      await fetchWeatherData();
    }

    async function fetchWeatherData() {
      try {
        // Richiesta all'API Ecowitt con unità in °C, hPa, km/h, mm
        const url = `https://api.ecowitt.net/api/v3/device/real_time?application_key=${APPLICATION_KEY}&api_key=${API_KEY}&mac=${MAC}&call_back=all&temp_unitid=1&pressure_unitid=3&wind_speed_unitid=7&rainfall_unitid=12`;
        const response = await fetch(url);
        const data = await response.json();
        console.log('Risposta API Ecowitt:', data);

        if (!data || data.code !== 0 || !data.data) {
          console.error('Struttura dati non valida:', data);
          return;
        }

        // Ultimo aggiornamento
        if (data.time) {
          const updateTime = new Date(parseInt(data.time) * 1000);
          document.getElementById('last-update').textContent =
            'Ultimo aggiornamento: ' + updateTime.toLocaleString('it-IT');
        }

        // === TEMPERATURA ===
        const tempObj = data.data.outdoor && data.data.outdoor.temperature;
        const tempNow = tempObj ? parseFloat(tempObj.value).toFixed(1) : 'N/D';
        document.getElementById('temp-now').textContent = tempNow;
        // min e max (non forniti dall'API, sostituiti da N/D)
        document.getElementById('temp-min').textContent = 'N/D';
        document.getElementById('temp-max').textContent = 'N/D';

        // === UMIDITÀ ===
        const humObj = data.data.outdoor && data.data.outdoor.humidity;
        const humNow = humObj ? humObj.value : 'N/D';
        document.getElementById('humidity-now').textContent = humNow;
        // min e max (non forniti dall'API, sostituiti da N/D)
        document.getElementById('humidity-min').textContent = 'N/D';
        document.getElementById('humidity-max').textContent = 'N/D';

        // === PIOGGIA ===
        const rainObj = data.data.rainfall;
        // Pioggia odierna
        const rainDaily = rainObj && rainObj.daily ? parseFloat(rainObj.daily.value).toFixed(1) : 'N/D';
        document.getElementById('rain-daily').textContent = rainDaily;
        // Livelli pioggia
        const rainEvent = rainObj && rainObj.event ? parseFloat(rainObj.event.value).toFixed(1) : 'N/D';
        const rainHourly = rainObj && rainObj.hourly ? parseFloat(rainObj.hourly.value).toFixed(1) : 'N/D';
        const rainWeekly = rainObj && rainObj.weekly ? parseFloat(rainObj.weekly.value).toFixed(1) : 'N/D';
        const rainMonthly = rainObj && rainObj.monthly ? parseFloat(rainObj.monthly.value).toFixed(1) : 'N/D';
        const rainYearly = rainObj && rainObj.yearly ? parseFloat(rainObj.yearly.value).toFixed(1) : 'N/D';
        document.getElementById('rain-event').textContent = rainEvent;
        document.getElementById('rain-hourly').textContent = rainHourly;
        document.getElementById('rain-weekly').textContent = rainWeekly;
        document.getElementById('rain-monthly').textContent = rainMonthly;
        document.getElementById('rain-yearly').textContent = rainYearly;

        // === VENTO ===
        const windObj = data.data.wind;
        const windSpeedObj = windObj && windObj.wind_speed;
        const windGustObj = windObj && windObj.wind_gust;
        const windDirObj = windObj && windObj.wind_direction;
        const windSpeed = windSpeedObj ? parseFloat(windSpeedObj.value).toFixed(1) : 'N/D';
        const windGust = windGustObj ? parseFloat(windGustObj.value).toFixed(1) : 'N/D';
        const windDir = windDirObj ? parseFloat(windDirObj.value).toFixed(0) : 'N/D';
        document.getElementById('wind-speed').textContent = windSpeed;
        document.getElementById('wind-gust').textContent = windGust;
        document.getElementById('wind-direction').textContent = windDir;

        // === PRESSIONE ===
        const pressObj = data.data.pressure && data.data.pressure.relative;
        const pressureNow = pressObj ? parseFloat(pressObj.value).toFixed(1) : 'N/D';
        document.getElementById('pressure-now').textContent = pressureNow;

        // === RADIAZIONE SOLARE / UVI ===
        const solarObj = data.data.solar_and_uvi && data.data.solar_and_uvi.solar;
        const uviObj = data.data.solar_and_uvi && data.data.solar_and_uvi.uvi;
        const solarVal = solarObj ? parseFloat(solarObj.value).toFixed(1) : 'N/D';
        const uviVal = uviObj ? parseFloat(uviObj.value).toFixed(1) : 'N/D';
        document.getElementById('solar-now').textContent = solarVal;
        document.getElementById('uvi-now').textContent = uviVal;

      } catch (error) {
        console.error('Errore nel recupero dati Ecowitt:', error);
      }
    }

    initPage();
  </script>
</body>
</html>
